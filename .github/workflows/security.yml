name: Security Scanning

on:
  schedule:
    # Run security scans daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual triggering
  pull_request:
    branches: [ main, develop ]

jobs:
  codeql-analysis:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      matrix:
        language: [ 'javascript' ]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v2
      with:
        languages: ${{ matrix.language }}
        queries: security-extended,security-and-quality

    - name: Autobuild
      uses: github/codeql-action/autobuild@v2

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2
      with:
        category: "/language:${{matrix.language}}"

  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Client dependency audit
      run: |
        cd client
        npm ci
        npm audit --audit-level high --json > client-audit.json || true

    - name: Server dependency audit
      run: |
        cd server
        npm ci
        npm audit --audit-level high --json > server-audit.json || true

    - name: Upload audit results
      uses: actions/upload-artifact@v3
      with:
        name: audit-results
        path: |
          client/client-audit.json
          server/server-audit.json
        retention-days: 30

    - name: Check for high vulnerabilities
      run: |
        HIGH_VULNS=0

        if [ -f client/client-audit.json ]; then
          CLIENT_HIGH=$(jq '.vulnerabilities | map(select(.severity == "high")) | length' client/client-audit.json || echo 0)
          HIGH_VULNS=$((HIGH_VULNS + CLIENT_HIGH))
          echo "Client high vulnerabilities: $CLIENT_HIGH"
        fi

        if [ -f server/server-audit.json ]; then
          SERVER_HIGH=$(jq '.vulnerabilities | map(select(.severity == "high")) | length' server/server-audit.json || echo 0)
          HIGH_VULNS=$((HIGH_VULNS + SERVER_HIGH))
          echo "Server high vulnerabilities: $SERVER_HIGH"
        fi

        if [ $HIGH_VULNS -gt 0 ]; then
          echo "âŒ Found $HIGH_VULNS high severity vulnerabilities"
          exit 1
        else
          echo "âœ… No high severity vulnerabilities found"
        fi

  container-scan:
    name: Container Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker images
      run: |
        docker build -t nasa-system7-client ./client
        docker build -t nasa-system7-server ./server

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'nasa-system7-client'
        format: 'sarif'
        output: 'client-trivy-results.sarif'

    - name: Run Trivy vulnerability scanner (server)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'nasa-system7-server'
        format: 'sarif'
        output: 'server-trivy-results.sarif'

    - name: Upload Trivy scan results (client)
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'client-trivy-results.sarif'
        category: client-container

    - name: Upload Trivy scan results (server)
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'server-trivy-results.sarif'
        category: server-container

  secrets-scan:
    name: Secrets Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for better scanning

    - name: Run Gitleaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: |
        npm run install-all

    - name: Run ESLint with security rules
      run: |
        cd client && npm run lint
        cd ../server && npm run lint

    - name: Run SonarCloud scan
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: nasa_system7_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: |
        npm run install-all

    - name: Setup test environment
      run: |
        cd server
        cp .env.example .env
        echo "NODE_ENV=test" >> .env
        echo "DB_HOST=localhost" >> .env
        echo "DB_PORT=5432" >> .env
        echo "DB_NAME=nasa_system7_test" >> .env
        echo "DB_USER=postgres" >> .env
        echo "DB_PASSWORD=postgres" >> .env
        echo "REDIS_HOST=localhost" >> .env
        echo "REDIS_PORT=6379" >> .env

    - name: Wait for services
      run: sleep 30

    - name: Run security tests
      run: |
        cd server
        npm run test:integration

  security-report:
    name: Security Report
    runs-on: ubuntu-latest
    needs: [codeql-analysis, dependency-audit, container-scan, secrets-scan, code-quality, security-tests]
    if: always()

    steps:
    - name: Generate security summary
      run: |
        echo "# Security Scan Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| CodeQL Analysis | ${{ contains(needs.codeql-analysis.result, 'success') && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Dependency Audit | ${{ contains(needs.dependency-audit.result, 'success') && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Container Scan | ${{ contains(needs.container-scan.result, 'success') && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Secrets Scan | ${{ contains(needs.secrets-scan.result, 'success') && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Code Quality | ${{ contains(needs.code-quality.result, 'success') && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Security Tests | ${{ contains(needs.security-tests.result, 'success') && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY

    - name: Notify on failure
      if: failure()
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        channel: '#security'
        text: 'ðŸš¨ Security scan failed! Please review the results.'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
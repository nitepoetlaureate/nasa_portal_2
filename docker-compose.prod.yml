# NASA System 7 Portal - Production Docker Compose Configuration
# Production-optimized with security, monitoring, and performance hardening

version: '3.8'

services:
  # ===== Database Service (Production) =====
  postgres:
    image: postgres:15-alpine
    container_name: nasa_system7_db_prod
    environment:
      POSTGRES_DB: ${DB_NAME}
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --lc-collate=C --lc-ctype=C"
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_prod_data:/var/lib/postgresql/data
      - ./server/scripts/init.sql:/docker-entrypoint-initdb.d/01-init.sql
      - ./server/scripts/prod-seed.sql:/docker-entrypoint-initdb.d/02-prod-seed.sql
      - postgres_backups:/backups
    networks:
      - nasa_prod_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER} -d ${DB_NAME}"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: always
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.0'
        reservations:
          memory: 1G
          cpus: '0.5'
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true
    read_only: false
    tmpfs:
      - /tmp

  # ===== Redis Cache Service (Production) =====
  redis:
    image: redis:7-alpine
    container_name: nasa_system7_redis_prod
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD} --maxmemory 512mb --maxmemory-policy allkeys-lru --save 900 1 --save 300 10 --save 60 10000
    volumes:
      - redis_prod_data:/data
      - redis_backups:/backups
    networks:
      - nasa_prod_network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: always
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true
    read_only: false
    tmpfs:
      - /tmp

  # ===== Server Backend (Production) =====
  server:
    build:
      context: ./server
      dockerfile: Dockerfile
      target: production
    image: nasa-system7-server:latest
    container_name: nasa_system7_server_prod
    environment:
      NODE_ENV: production
      PORT: 3001
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      NASA_API_KEY: ${NASA_API_KEY}
      JPL_API_KEY: ${JPL_API_KEY}
      JWT_SECRET: ${JWT_SECRET}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      ENABLE_CORS: "false"
      ENABLE_SWAGGER: "false"
      ENABLE_METRICS: "true"
      TRUST_PROXY: "true"
    volumes:
      - server_prod_logs:/app/logs
      - server_uploads:/app/uploads
    networks:
      - nasa_prod_network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "--max-time", "5", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s
    restart: always
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'
      replicas: 2
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 3
        window: 120s
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"
    security_opt:
      - no-new-privileges:true
    read_only: false
    tmpfs:
      - /tmp
      - /app/tmp

  # ===== Client Frontend (Production) =====
  client:
    build:
      context: ./client
      dockerfile: Dockerfile
      target: production
    image: nasa-system7-client:latest
    container_name: nasa_system7_client_prod
    environment:
      NODE_ENV: production
      REACT_APP_API_URL: https://api.nasa-system7.example.com
      REACT_APP_ENVIRONMENT: production
      NGINX_WORKER_PROCESSES: "auto"
      NGINX_WORKER_CONNECTIONS: "2048"
    volumes:
      - client_prod_logs:/var/log/nginx
      - nginx_cache:/var/cache/nginx
    networks:
      - nasa_prod_network
    depends_on:
      server:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "--max-time", "5", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: always
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'
      replicas: 2
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /var/cache/nginx
      - /var/run

  # ===== Load Balancer =====
  nginx-lb:
    image: nginx:1.25-alpine
    container_name: nasa_system7_nginx_lb
    volumes:
      - ./nginx/nginx-lb.conf:/etc/nginx/nginx.conf:ro
      - nginx_lb_logs:/var/log/nginx
      - nginx_lb_cache:/var/cache/nginx
    ports:
      - "80:80"
      - "443:443"
    networks:
      - nasa_prod_network
    depends_on:
      - client
    healthcheck:
      test: ["CMD", "curl", "-f", "--max-time", "5", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: always
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'
        reservations:
          memory: 128M
          cpus: '0.1'
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true

  # ===== Monitoring Stack =====
  prometheus:
    image: prom/prometheus:v2.45.0
    container_name: nasa_system7_prometheus_prod
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=30d'
      - '--web.enable-lifecycle'
      - '--web.enable-admin-api'
      - '--alertmanager.notification-queue-capacity=10000'
    volumes:
      - ./monitoring/prometheus.prod.yml:/etc/prometheus/prometheus.yml:ro
      - ./monitoring/alert.rules.yml:/etc/prometheus/alert.rules.yml:ro
      - prometheus_prod_data:/prometheus
    networks:
      - nasa_prod_network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: always
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
        reservations:
          memory: 512M
          cpus: '0.25'
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true
    read_only: false
    tmpfs:
      - /prometheus_tmp

  grafana:
    image: grafana/grafana:10.0.0
    container_name: nasa_system7_grafana_prod
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD}
      GF_USERS_ALLOW_SIGN_UP: false
      GF_SECURITY_DISABLE_GRAVATAR: "true"
      GF_SECURITY_COOKIE_SECURE: "true"
      GF_SECURITY_COOKIE_SAMESITE: "strict"
      GF_SECURITY_X_CONTENT_TYPE_OPTIONS: "true"
      GF_SECURITY_X_XSS_PROTECTION: "true"
      GF_SERVER_PROTOCOL: "https"
      GF_SERVER_DOMAIN: "grafana.nasa-system7.example.com"
      GF_SERVER_ROOT_URL: "https://grafana.nasa-system7.example.com"
      GF_SERVER_CERT_FILE: "/etc/ssl/certs/grafana.crt"
      GF_SERVER_CERT_KEY: "/etc/ssl/certs/grafana.key"
      GF_INSTALL_PLUGINS: "grafana-clock-panel,grafana-simple-json-datasource,grafana-piechart-panel"
    volumes:
      - grafana_prod_data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./ssl/certs:/etc/ssl/certs:ro
    networks:
      - nasa_prod_network
    depends_on:
      - prometheus
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: always
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true

  alertmanager:
    image: prom/alertmanager:v0.26.0
    container_name: nasa_system7_alertmanager_prod
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
      - '--web.external-url=https://alertmanager.nasa-system7.example.com'
      - '--cluster.listen-address=0.0.0.0:9094'
    volumes:
      - ./monitoring/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - alertmanager_prod_data:/alertmanager
    networks:
      - nasa_prod_network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9093/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: always
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'
        reservations:
          memory: 128M
          cpus: '0.1'
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true

  # ===== Log Aggregation =====
  loki:
    image: grafana/loki:2.9.0
    container_name: nasa_system7_loki_prod
    command:
      - '-config.file=/etc/loki/local-config.yaml'
      - '-server.http-listen-port=3100'
    volumes:
      - ./monitoring/loki-config.yaml:/etc/loki/local-config.yaml:ro
      - loki_prod_data:/loki
    networks:
      - nasa_prod_network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3100/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: always
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
        reservations:
          memory: 512M
          cpus: '0.25'
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true

  promtail:
    image: grafana/promtail:2.9.0
    container_name: nasa_system7_promtail_prod
    command:
      - '-config.file=/etc/promtail/config.yml'
      - '-client.url=http://loki:3100/loki/api/v1/push'
    volumes:
      - ./monitoring/promtail-config.yml:/etc/promtail/config.yml:ro
      - /var/log:/var/log:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - client_prod_logs:/var/log/client:ro
      - server_prod_logs:/var/log/server:ro
      - nginx_lb_logs:/var/log/nginx:ro
    networks:
      - nasa_prod_network
    depends_on:
      - loki
    restart: always
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'
        reservations:
          memory: 128M
          cpus: '0.1'
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true

# ===== Networks =====
networks:
  nasa_prod_network:
    driver: bridge
    name: nasa_prod_network
    ipam:
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1
    driver_opts:
      com.docker.network.bridge.name: nasa_prod_br
      com.docker.network.driver.mtu: 1500

# ===== Volumes =====
volumes:
  postgres_prod_data:
    driver: local
    name: nasa_system7_postgres_prod_data
    driver_opts:
      type: none
      o: bind
      device: /opt/nasa_system7/data/postgres
  redis_prod_data:
    driver: local
    name: nasa_system7_redis_prod_data
    driver_opts:
      type: none
      o: bind
      device: /opt/nasa_system7/data/redis
  server_prod_logs:
    driver: local
    name: nasa_system7_server_prod_logs
  client_prod_logs:
    driver: local
    name: nasa_system7_client_prod_logs
  nginx_lb_logs:
    driver: local
    name: nasa_system7_nginx_lb_logs
  nginx_lb_cache:
    driver: local
    name: nasa_system7_nginx_lb_cache
  nginx_cache:
    driver: local
    name: nasa_system7_nginx_cache
  prometheus_prod_data:
    driver: local
    name: nasa_system7_prometheus_prod_data
    driver_opts:
      type: none
      o: bind
      device: /opt/nasa_system7/data/prometheus
  grafana_prod_data:
    driver: local
    name: nasa_system7_grafana_prod_data
    driver_opts:
      type: none
      o: bind
      device: /opt/nasa_system7/data/grafana
  alertmanager_prod_data:
    driver: local
    name: nasa_system7_alertmanager_prod_data
  loki_prod_data:
    driver: local
    name: nasa_system7_loki_prod_data
    driver_opts:
      type: none
      o: bind
      device: /opt/nasa_system7/data/loki
  postgres_backups:
    driver: local
    name: nasa_system7_postgres_backups
    driver_opts:
      type: none
      o: bind
      device: /opt/nasa_system7/backups/postgres
  redis_backups:
    driver: local
    name: nasa_system7_redis_backups
    driver_opts:
      type: none
      o: bind
      device: /opt/nasa_system7/backups/redis
  server_uploads:
    driver: local
    name: nasa_system7_server_uploads